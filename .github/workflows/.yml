name: Winwer- Servidor HTTP Custom

on:
  workflow_dispatch: # Permite ejecutarlo manualmente
  push:
    branches:
      - main

jobs:
  setup-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: 📦 Clonar el repositorio
      uses: actions/checkout@v4

    - name: ⚙️ Actualizar el sistema
      run: |
        sudo apt update && sudo apt upgrade -y

    - name: 🧰 Instalar herramientas básicas
      run: |
        sudo apt install -y curl wget unzip nano screen net-tools htop

    - name: 🌐 Instalar y configurar Nginx
      run: |
        sudo apt install nginx -y
        sudo systemctl enable nginx
        sudo systemctl start nginx

    - name: 🔄 Configurar proxy HTTP para túnel
      run: |
        echo "Configurando proxy inverso para puerto 8080..."
        sudo bash -c 'cat > /etc/nginx/sites-available/default <<EOF
        server {
            listen 8080;
            server_name _;
            location / {
                proxy_pass http://127.0.0.1:22;
                proxy_redirect off;
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
            }
        }
        EOF'
        sudo systemctl restart nginx

    - name: ✅ Verificar instalación
      run: |
        echo "Nginx activo en puerto 8080:"
        sudo systemctl status nginx | grep Active
        echo "Dirección IP pública:"
        curl ifconfig.me
